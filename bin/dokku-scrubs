#!/usr/bin/env bash

set -euo pipefail

LIB_DIR="/usr/local/lib/dokku-scrubs"

# Uncomment for local development only.
#LIB_DIR="$HOME/.local/lib/dokku-scrubs"

source "$LIB_DIR/config.sh"
source "$LIB_DIR/common.sh"
source "$LIB_DIR/init.sh"
source "$LIB_DIR/db.sh"
source "$LIB_DIR/app.sh"
source "$LIB_DIR/letsencrypt.sh"
source "$LIB_DIR/shflags"

DEFINE_string  "app"         "$DEFAULT_APP" "the type of app to deploy" "a"
DEFINE_string  "domain"      "$DEFAULT_DOMAIN" "the domain of your server" "d"
DEFINE_string  "dokku_tag"   "$DEFAULT_DOKKU_TAG" "version of Dokku to use. default: $DEFAULT_DOKKU_TAG" "t"
DEFINE_string  "database"    "$DEFAULT_DATABASE" "the type of database to use. default: $DEFAULT_DATABASE" "D"
DEFINE_string  "email"       "$DEFAULT_EMAIL" "email address for letsencrypt" "e"
DEFINE_boolean "letsencrypt" false "pass this flag to enable SSL" "l"
DEFINE_boolean "testcert"    false "pass this flag along with --letsencrypt, to get certs from the staging server" "T"

DEFINE_boolean "version" false "show version and exit" "v"

FLAGS "$@" || exit $?
eval set -- "${FLAGS_ARGV}"

if [[ ${FLAGS_version} -eq ${FLAGS_TRUE} ]]; then
  echo "dokku-scrubs v$DOKKU_SCRUBS_VERSION"
  exit 0
fi

require_root
# TODO: Improve validation
if [[ -z "${FLAGS_app}" || -z "${FLAGS_domain}" ]]; then
  log "--domain and --app are required."
  exit 1
fi
if [[ ${FLAGS_letsencrypt} -eq ${FLAGS_TRUE} && -z "${FLAGS_email}" ]]; then
  log "--email is required when setting --letsencrypt"
  exit 1
fi

init_dokku "${FLAGS_domain}" "${FLAGS_dokku_tag}" "${FLAGS_database}"
create_app "${FLAGS_app}"
setup_db "${FLAGS_database}" "${FLAGS_app}"
mount_volume "${FLAGS_app}"
deploy_app "${FLAGS_app}" "${FLAGS_domain}"
map_port "${FLAGS_app}"

if [ ${FLAGS_letsencrypt} -eq ${FLAGS_TRUE} ]; then
  enable_ssl "${FLAGS_app}" "${FLAGS_email}" "${FLAGS_testcert}"
fi
